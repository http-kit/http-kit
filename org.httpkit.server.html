<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>org.httpkit.server documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Http-kit</span> <span class="project-version">2.8.0-RC1</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>org</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>httpkit</span></div></div></li><li class="depth-3 branch"><a href="org.httpkit.client.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>client</span></div></a></li><li class="depth-3 branch"><a href="org.httpkit.encode.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>encode</span></div></a></li><li class="depth-3 branch current"><a href="org.httpkit.server.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>server</span></div></a></li><li class="depth-3 branch"><a href="org.httpkit.sni-client.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>sni-client</span></div></a></li><li class="depth-3 branch"><a href="org.httpkit.timer.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>timer</span></div></a></li><li class="depth-3"><a href="org.httpkit.utils.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>utils</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="org.httpkit.server.html#var-accept"><div class="inner"><span>accept</span></div></a></li><li class="depth-1"><a href="org.httpkit.server.html#var-as-channel"><div class="inner"><span>as-channel</span></div></a></li><li class="depth-1"><a href="org.httpkit.server.html#var-Channel"><div class="inner"><span>Channel</span></div></a></li><li class="depth-2 branch"><a href="org.httpkit.server.html#var-close"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>close</span></div></a></li><li class="depth-2 branch"><a href="org.httpkit.server.html#var-on-close"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>on-close</span></div></a></li><li class="depth-2 branch"><a href="org.httpkit.server.html#var-on-ping"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>on-ping</span></div></a></li><li class="depth-2 branch"><a href="org.httpkit.server.html#var-on-receive"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>on-receive</span></div></a></li><li class="depth-2 branch"><a href="org.httpkit.server.html#var-open.3F"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>open?</span></div></a></li><li class="depth-2 branch"><a href="org.httpkit.server.html#var-send.21"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>send!</span></div></a></li><li class="depth-2"><a href="org.httpkit.server.html#var-websocket.3F"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>websocket?</span></div></a></li><li class="depth-1"><a href="org.httpkit.server.html#var-IHttpServer"><div class="inner"><span>IHttpServer</span></div></a></li><li class="depth-2 branch"><a href="org.httpkit.server.html#var--server-stop.21"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>-server-stop!</span></div></a></li><li class="depth-2 branch"><a href="org.httpkit.server.html#var-server-port"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>server-port</span></div></a></li><li class="depth-2"><a href="org.httpkit.server.html#var-server-status"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>server-status</span></div></a></li><li class="depth-1"><a href="org.httpkit.server.html#var-new-worker"><div class="inner"><span>new-worker</span></div></a></li><li class="depth-1"><a href="org.httpkit.server.html#var-run-server"><div class="inner"><span>run-server</span></div></a></li><li class="depth-1"><a href="org.httpkit.server.html#var-sec-websocket-accept"><div class="inner"><span>sec-websocket-accept</span></div></a></li><li class="depth-1"><a href="org.httpkit.server.html#var-send-checked-websocket-handshake.21"><div class="inner"><span>send-checked-websocket-handshake!</span></div></a></li><li class="depth-1"><a href="org.httpkit.server.html#var-send-websocket-handshake.21"><div class="inner"><span>send-websocket-handshake!</span></div></a></li><li class="depth-1"><a href="org.httpkit.server.html#var-server-stop.21"><div class="inner"><span>server-stop!</span></div></a></li><li class="depth-1"><a href="org.httpkit.server.html#var-websocket-handshake-check"><div class="inner"><span>websocket-handshake-check</span></div></a></li><li class="depth-1"><a href="org.httpkit.server.html#var-with-channel"><div class="inner"><span>with-channel</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">org.httpkit.server</h1><div class="doc"><pre class="plaintext"></pre></div><div class="public anchor" id="var-accept"><h3>accept</h3><h4 class="deprecated">deprecated in v2.4.0 (2020-07-30)</h4><div class="usage"></div><div class="doc"><pre class="plaintext">DEPRECATED: prefer `sec-websocket-accept`
</pre></div></div><div class="public anchor" id="var-as-channel"><h3>as-channel</h3><div class="usage"><code>(as-channel ring-req {:keys [on-receive on-ping on-close on-open init on-handshake-error], :or {on-handshake-error (fn [ch] (send! ch bad-ring-websocket-resp true))}})</code></div><div class="doc"><pre class="plaintext">Returns `{:body ch}`, where `ch` is the request's underlying
asynchronous HTTP or WebSocket `AsyncChannel`.

Main options:
  :init       - (fn [ch])             for misc pre-handshake setup.
  :on-receive - (fn [ch message])     called for client WebSocket messages.
  :on-ping    - (fn [ch data])        called for client WebSocket pings.
  :on-close   - (fn [ch status-code]) called when AsyncChannel is closed.
  :on-open    - (fn [ch])             called when AsyncChannel is ready for `send!`, etc.

See `Channel` protocol for more info on handlers and `AsyncChannel`s.
See `org.httpkit.timer` ns for optional timeout utils.

---

Example - Async HTTP response:

  (def clients_ (atom #{}))
  (defn my-async-handler [ring-req]
    (as-channel ring-req
      {:on-open (fn [ch] (swap! clients_ conj ch))}))

  ;; Somewhere else in your code
  (doseq [ch @clients_]
    (swap! clients_ disj ch)
    (send! ch {:status 200 :headers {"Content-Type" "text/html"}
               :body "Your async response"}
      ;; false ; Uncomment to use chunk encoding for HTTP streaming
      ))

Example - WebSocket response:

  (defn my-chatroom-handler [ring-req]
    (if-not (:websocket? ring-req)
      {:status 200 :body "Welcome to the chatroom! JS client connecting..."}
      (as-channel ring-req
        {:on-receive (fn [ch message]     (println "on-receive:" message))
         :on-close   (fn [ch status-code] (println "on-close:"   status-code))
         :on-open    (fn [ch]             (println "on-open:"    ch))})))</pre></div></div><div class="public anchor" id="var-Channel"><h3>Channel</h3><h4 class="type">protocol</h4><div class="usage"></div><div class="doc"><pre class="plaintext">Unified asynchronous channel interface for HTTP (streaming or long-polling)
and WebSocket.</pre></div><div class="members"><h4>members</h4><div class="inner"><div class="public anchor" id="var-close"><h3>close</h3><div class="usage"><code>(close ch)</code></div><div class="doc"><pre class="plaintext">Closes the channel. Idempotent: returns true if the channel was actually
closed, or false if it was already closed.</pre></div></div><div class="public anchor" id="var-on-close"><h3>on-close</h3><div class="usage"><code>(on-close ch callback)</code></div><div class="doc"><pre class="plaintext">Sets handler (fn [status-code]) for notification of channel being closed by
the server or client. Handler will be invoked at most once. Useful for clean-up.

Callback status argument:
  :server-close   : Channel closed by sever
  :client-close   : HTTP channel closed by client
  :normal         : WebSocket closed by client (CLOSE_NORMAL)
  :going-away     : WebSocket closed by client (CLOSE_GOING_AWAY)
  :protocol-error : WebSocket closed by client (CLOSE_PROTOCOL_ERROR)
  :unsupported    : WebSocket closed by client (CLOSE_UNSUPPORTED)
  :unknown        : WebSocket closed by client (unknown reason)</pre></div></div><div class="public anchor" id="var-on-ping"><h3>on-ping</h3><div class="usage"><code>(on-ping ch callback)</code></div><div class="doc"><pre class="plaintext">Sets handler (fn [data]) for notification of client WebSocket pings. The
data param represents application data and will by a byte[].</pre></div></div><div class="public anchor" id="var-on-receive"><h3>on-receive</h3><div class="usage"><code>(on-receive ch callback)</code></div><div class="doc"><pre class="plaintext">Sets handler (fn [message]) for notification of client WebSocket
messages. Message ordering is guaranteed by server.

The message argument could be a string or a byte[].</pre></div></div><div class="public anchor" id="var-open.3F"><h3>open?</h3><div class="usage"><code>(open? ch)</code></div><div class="doc"><pre class="plaintext">Returns true iff channel is open.
</pre></div></div><div class="public anchor" id="var-send.21"><h3>send!</h3><div class="usage"><code>(send! ch data)</code><code>(send! ch data close-after-send?)</code></div><div class="doc"><pre class="plaintext">Sends data to client and returns true if the data was successfully sent,
or false if the channel is closed. Data is sent directly to the client,
NO RING MIDDLEWARE IS APPLIED.

When unspecified, `close-after-send?` defaults to true for HTTP channels
and false for WebSocket.

Data form: {:headers _ :status _ :body _} or just body. Note that :headers
and :status will be stripped for WebSocket and for HTTP streaming responses
after the first.

For WebSocket, a text frame is sent to client if data is String,
a binary frame when data is byte[] or InputStream. For for HTTP streaming
responses, data can be one of the type defined by Ring spec</pre></div></div><div class="public anchor" id="var-websocket.3F"><h3>websocket?</h3><div class="usage"><code>(websocket? ch)</code></div><div class="doc"><pre class="plaintext">Returns true iff channel is a WebSocket.
</pre></div></div></div></div></div><div class="public anchor" id="var-IHttpServer"><h3>IHttpServer</h3><h4 class="type">protocol</h4><div class="usage"></div><div class="doc"><pre class="plaintext"></pre></div><div class="members"><h4>members</h4><div class="inner"><div class="public anchor" id="var--server-stop.21"><h3>-server-stop!</h3><div class="usage"><code>(-server-stop! http-server opts)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-server-port"><h3>server-port</h3><div class="usage"><code>(server-port http-server)</code></div><div class="doc"><pre class="plaintext">Given an HttpServer, returns server's local port.
</pre></div></div><div class="public anchor" id="var-server-status"><h3>server-status</h3><div class="usage"><code>(server-status http-server)</code></div><div class="doc"><pre class="plaintext">Given an HttpServer, returns server's status e/o #{:stopped :running :stopping}.
</pre></div></div></div></div></div><div class="public anchor" id="var-new-worker"><h3>new-worker</h3><div class="usage"><code>(new-worker {:keys [queue-size n-min-threads n-max-threads prefix allow-virtual?], :as opts})</code></div><div class="doc"><pre class="plaintext">Returns {:keys [n-cores type pool ...]} where `:pool` is a new
`java.util.concurrent.ExecutorService` for handling server requests.

When on JVM 21+, uses `newVirtualThreadPerTaskExecutor` by default.
Otherwise creates a standard `ThreadPoolExecutor` with default min and max
thread count auto-selected based on currently available processor count.</pre></div></div><div class="public anchor" id="var-run-server"><h3>run-server</h3><div class="usage"><code>(run-server handler &amp; [{:keys [ip port max-body max-ws max-line proxy-protocol worker-pool error-logger warn-logger event-logger event-names legacy-return-value? server-header address-finder channel-factory ring-async?], :as opts, :or {max-ws 4194304, ring-async? false, max-body 8388608, max-line 8192, server-header "http-kit", ip "0.0.0.0", proxy-protocol :disable, port 8090, legacy-return-value? true}}])</code></div><div class="doc"><pre class="plaintext">Starts a mostly[1] Ring-compatible HttpServer with options:

  :ip                 ; Which IP to bind (default: 0.0.0.0)
  :port               ; Which port to listen to for incoming requests

  :worker-pool        ; `java.util.concurrent.ExecutorService` or delay to use
                      ; for handling requests. Defaults to (:pool (new-worker {})).
                      ; See `new-worker` for details.

  :max-body           ; Max HTTP body size in bytes (default: 8MB)
  :max-ws             ; Max WebSocket message size in bytes (default: 4MB)
  :max-line           ; Max HTTP header line size in bytes (default: 8KB)

  :proxy-protocol     ; Proxy protocol e/o #{:disable :enable :optional}

  :server-header      ; The "Server" header, disabled if nil. Default: "http-kit".

  :error-logger       ; (fn [msg ex])  -&gt; log errors
  :warn-logger        ; (fn [msg ex])  -&gt; log warnings
  :event-logger       ; (fn [ev-name]) -&gt; log events
  :event-names        ; Map of http-kit event names to loggable event names

  ;; These opts may be used for Unix Domain Socket (UDS) support, see README:
  :address-finder     ; (fn []) -&gt; `java.net.SocketAddress` (ip/port ignored)
  :channel-factory    ; (fn [java.net.SocketAddress]) -&gt; `java.nio.channels.SocketChannel`

If :legacy-return-value? is
  true  (default)     ; Returns a (fn stop-server [&amp; {:keys [timeout] :or {timeout 100}}])
  false (recommended) ; Returns the `HttpServer` which can be used with `server-port`,
                      ; `server-status`, `server-stop!`, etc.

The server also supports the following JVM properties:

   `org.http-kit.memmap-file-threshold`
     Files above this size (in MB) are mapped into memory for efficiency when served.
     Memory mapping could result to file locking. Defaults to 20 (MB).

[1] Ref. <a href="http://http-kit.org/migration.html">http://http-kit.org/migration.html</a> for differences.</pre></div></div><div class="public anchor" id="var-sec-websocket-accept"><h3>sec-websocket-accept</h3><div class="usage"><code>(sec-websocket-accept sec-websocket-key)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-send-checked-websocket-handshake.21"><h3>send-checked-websocket-handshake!</h3><div class="usage"><code>(send-checked-websocket-handshake! ch sec-ws-accept)</code></div><div class="doc"><pre class="plaintext">Given an AsyncChannel and `sec-ws-accept` string, unconditionally
sends handshake to upgrade given AsyncChannel to a WebSocket.
See also `websocket-handshake-check`.</pre></div></div><div class="public anchor" id="var-send-websocket-handshake.21"><h3>send-websocket-handshake!</h3><div class="usage"><code>(send-websocket-handshake! ch ring-req)</code></div><div class="doc"><pre class="plaintext">Returns true iff successfully upgraded a valid WebSocket request.
</pre></div></div><div class="public anchor" id="var-server-stop.21"><h3>server-stop!</h3><div class="usage"><code>(server-stop! http-server)</code><code>(server-stop! http-server opts)</code></div><div class="doc"><pre class="plaintext">Signals given HttpServer to stop.

If     already stopping: returns nil.
If not already stopping: returns a Promise that will be delivered once
server thread actually completes.

Options:
  :timeout ; Max msecs to allow existing requests to complete before attempting
           ; interrupt (default 100).</pre></div></div><div class="public anchor" id="var-websocket-handshake-check"><h3>websocket-handshake-check</h3><div class="usage"><code>(websocket-handshake-check ring-req)</code></div><div class="doc"><pre class="plaintext">Returns `sec-ws-accept` string iff given Ring request is a valid
WebSocket handshake.</pre></div></div><div class="public anchor" id="var-with-channel"><h3>with-channel</h3><h4 class="type">macro</h4><h4 class="deprecated">deprecated in v2.4.0 (2020-07-30)</h4><div class="usage"><code>(with-channel ring-req ch-name &amp; body)</code></div><div class="doc"><pre class="plaintext">DEPRECATED: this macro has potential race conditions, Ref. #318.
Prefer `as-channel` instead.</pre></div></div></div></body></html>